<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Profile Page</title>
    <!-- Bootstrap -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
    </style>
</head>

<body>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="http://sabioapi2.azurewebsites.net/scripts/sabio.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.17.0/dist/jquery.validate.min.js"></script>
    <!-- All your code goes below here-->
    <form id="profileForm">
    <h4>Username: <span id="username"></span></h4>
    <h1>Profile Form</h1>
    <p>Title: 
    <input type="text" id="title" placeholder="Enter Title Here"></p>
    <p>Bio:
    <input type="text" id="bio" placeholder="Enter Bio Here"></p>
    <p>Summary:
    <input type="text" id="summary" placeholder="Enter Summary Here"></p>
    <p>Headline:
    <input type="text" id="headline" placeholder="Enter Headline Here"></p>
    <p>Slug:
    <input type="text" id="slug" placeholder="Enter Slug Here"></p>
    <p>Status id:
    <input type="text" id="statusid" placeholder="Enter Status ID Here"></p>
    <p>Skills:
    <input type="text" id="skill" placeholder="Enter Skills Here"></p>
    <p>Primary Image Attachment.
    <input type="file" name="image" id="image" accept="image/*"></p>
    <button type="button" id="btn-submit">Submit</button>
</form>
<div id="landing"></div>
    <script>
        sabio.page.startUp=()=>{
            sabio.page.onGetCurrentId();
            sabio.page.onGetPeople();
            $('#btn-submit').on('click', sabio.page.pushFiletoAjax)
            $('#landing').on('click','.edit',sabio.page.handlers.getPersonById);
        }
        sabio.page.onError = (XHR, textStatus, error) => {
            console.log(XHR);
        }
        sabio.page.getEmail = (data) => {
            var email = (data.item.email);
            $('#username').text(email);
        }
        sabio.page.getCurrentUser = (data) => {
            var id = (data.item.actualUserId);
            sabio.page.getUsername(id);
        }
        sabio.page.getUsername = (userid) => {
            let url = "http://sabiobootcampapi.azurewebsites.net/api/users/" +userid;
            let settings = {
                cache: false,
                contentType: "application/x-www-form-urlencoded",
                dataType: 'json',
                success: sabio.page.getEmail,
                error: sabio.page.onError,
                type: "GET",
                xhrFields: {
                    withCredentials: true
                },
            };
            $.ajax(url, settings);
        }
        sabio.page.onGetCurrentId = () =>{
            let url= "http://sabiobootcampapi.azurewebsites.net/api/tests/auth/current";
            let settings = {
                cache: false,
                contentType:"application/x-www-form-urlencoded",
                dataType: 'json',
                success: sabio.page.getCurrentUser,
                error: sabio.page.onError,
                type: "GET",
                xhrFields: {
                    withCredentials: true
                },
            };
            $.ajax(url, settings);
        }
        sabio.page.pushFiletoAjax = (data) => {
           let url = "http://sabiobootcampapi.azurewebsites.net/api/files";
           const formData = new FormData();
           formData.append('image', $('#image')[0].files[0]);
           let settings = {
               cache: false
               , contentType: false
               , processData: false
               , dataType: "json"
               , type: "POST"
               , success: sabio.page.onPostLinkSuccess
               , error: sabio.page.ajaxError
               , data: formData
               ,
               xhrFields: {
                   withCredentials: true
               }
           };
           $.ajax(url, settings);
       }
       sabio.page.onPostLinkSuccess = (data) => {
           let link = data.items[0].url;
           let profile = sabio.page.readData(link);
           if (sabio.page.currentId){
               profile.id = sabio.page.currentId;
               sabio.page.updatePerson(profile);
           }
           else {
                sabio.page.onAddPeople(profile);
           }
       }
        sabio.page.readData=(link)=>{
            return {
                title: $('#title').val(),
                bio: $('#bio').val(),
                summary: $('#summary').val(),
                headline: $('#headline').val(),
                slug: $('#slug').val(),
                skills: $('#skill').val(),
                primaryImage: link
            };
        }
        sabio.page.onAddPeople = (people) =>{
            let url= "http://sabiobootcampapi.azurewebsites.net/api/people";
            let settings = {
                cache: false,
                contentType:"application/x-www-form-urlencoded",
                dataType: 'json',
                success: sabio.page.display,
                error: sabio.page.onError,
                type: "POST",
                data:people,
                xhrFields: {
                    withCredentials: true
                },
            };
            $.ajax(url, settings);
        }
        sabio.page.display = (item) => {
            sabio.page.onGetPerson(item);
            sabio.page.onGetPeople();
        }
       sabio.page.onGetPerson = (respond) =>{
        let id = respond.item;
        let url= "http://sabiobootcampapi.azurewebsites.net/api/people/"+id;
            let settings = {
                cache: false,
                contentType:"application/x-www-form-urlencoded",
                dataType: 'json',
                success: sabio.page.getPerson,
                error: sabio.page.onError,
                type: "GET",
                xhrFields: {
                    withCredentials: true
                },
            };
            $.ajax(url, settings);
       }
       sabio.page.getPerson = (data) =>{
                var template = $($('#template').html());
                template.find('.header').text("Your Profile");
                template.find(".title").text(data.item.title);
                template.find('.bio').text(data.item.bio);
                template.find(".summary").text(data.item.summary);
                template.find('.headline').text(data.item.headline);
                template.find('.slug').text(data.item.slug);
                template.find('.skills').text(data.item.skills.name);
                template.find('img').attr('src',data.item.primaryImage.imageUrl);
                $('#landing').append(template);      
       }
       sabio.page.onGetPeople = () =>{
        let pageIndex = 1;
        let pageSize = 10;
        let url= "http://sabiobootcampapi.azurewebsites.net/api/people/"+pageIndex+"/"+pageSize;
            let settings = {
                cache: false,
                contentType:"application/x-www-form-urlencoded",
                dataType: 'json',
                success: sabio.page.getPeople,
                error: sabio.page.onError,
                type: "GET",
                xhrFields: {
                    withCredentials: true
                },
            };
            $.ajax(url, settings);
       }
       sabio.page.getPeople = (data) =>{
           for( let i = 0 ; i <data.item.pagedItems.length;i++){
                var template = $($('#template').html());
                template.find(".title").text(data.item.pagedItems[i].title);
                template.find('.bio').text(data.item.pagedItems[i].bio);
                template.find(".summary").text(data.item.pagedItems[i].summary);
                template.find('.headline').text(data.item.pagedItems[i].headline);
                template.find('.slug').text(data.item.pagedItems[i].slug);
                template.find('.skills').text(data.item.pagedItems[i].skills[0].name);
                template.find('img').attr('src',data.item.pagedItems[i].primaryImage.imageUrl);
                template.prop('id',data.item.pagedItems[i].id);
                $('#landing').append(template);    
            }  
       }
       sabio.page.handlers.getPersonById = () => {
           sabio.page.currentId = $(this).closest(".profile").prop("id");
           sabio.page.getPersonById(sabio.page.currentId);
       }
       sabio.page.getPersonById =(id) =>{
           let url = "http://sabiobootcampapi.azurewebsites.net/api/people/"+id;
           let settings = {
                cache: false,
                contentType:"application/x-www-form-urlencoded",
                dataType: 'json',
                success: sabio.page.onGetPersonByIdSuccess,
                error: sabio.page.onError,
                type: "GET",
                xhrFields: {
                    withCredentials: true
                },
            };
            $.ajax(url, settings);
       }
       sabio.page.onGetPersonByIdSuccess = () => {
           $("#title").val(data.item.title);
           $("#bio").val(data.item.bio);
           $("#summary").val(data.item.summary);
           $("#headline").val(data.item.headline);
           $("#slug").val(data.item.slug);
           $("#skills").val(data.item.skills);
       }
       sabio.page.updatePerson = (update) => {
        let url = "http://sabiobootcampapi.azurewebsites.net/api/people/"+update.id;
           let settings = {
                cache: false,
                contentType:"application/x-www-form-urlencoded",
                dataType: 'json',
                success: sabio.page.onUpdatePersonSuccess,
                error: sabio.page.onError,
                type: "GET",
                data: update,
                xhrFields: {
                    withCredentials: true
                },
            };
            $.ajax(url, settings);
       }
       sabio.page.onUpdatePersonSuccess = () =>{
           $("#profileForm")[0].reset();
           sabio.page.onGetPeople();
           sabio.page.currentId = null;
       }
    </script>
    <script type="text/html" id="template">
        <div class="profile col-md-4">
            <p class="header"></p>
            <li>Title: <span class="title"></span></li>
            <li>Bio: <span class="bio"></span></li>
            <li>Summary: <span class="summary"></span></li>
            <li>Headline: <span class="headline"></span></li>
            <li>slug: <span class="slug"></span></li>
            <li>Skills: <span class="skills"></span></li>
            <img src="" alt="" width="200" height="250">
            <button class="btn-danger edit">Edit</button>
        </div>
    </script>
    
</body>